external ( = ) : int -> int -> bool = "="
external ( < ) : int -> int -> bool = "<"
external ( - ) : int -> int -> int = "-"
external ( + ) : int -> int -> int = "+"

effect Fail : unit -> int

let rec loop_latent n =
    if n = 0 then
        #Fail ()
    else if n < 0 then
        #Fail ()
    else
        loop_latent (n - 1)

let latent_handler = handler
| val y -> y
| #Fail () k -> k 0

let test_latent n =
    loop_latent n;;

let test_once () =
    with latent_handler handle (test_latent 10000);;

let rec test_many n =
    if n = 0 then
        ()
    else
        let a = test_once () in
        test_many (n - 1 + a);;

test_many 10000000
